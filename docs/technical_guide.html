<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V2N Robot - Complete Technical Guide</title>
    <style>
        :root {
            --primary: #3498db;
            --secondary: #9b59b6;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --gray: #7f8c8d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.8;
            color: #333;
            background: #f9f9f9;
            font-size: 16px;
        }

        /* Header */
        .hero {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 80px 20px;
            text-align: center;
        }

        .hero h1 {
            font-size: 3em;
            margin-bottom: 20px;
            font-weight: 300;
        }

        .hero h1 span {
            font-weight: 700;
        }

        .hero p {
            font-size: 1.3em;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Navigation */
        .toc {
            background: white;
            padding: 30px;
            max-width: 1000px;
            margin: -40px auto 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .toc h2 {
            color: var(--dark);
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .toc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .toc a {
            display: block;
            padding: 15px 20px;
            background: var(--light);
            color: var(--dark);
            text-decoration: none;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }

        .toc a:hover {
            background: #fff;
            border-left-color: var(--primary);
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .toc a span {
            display: block;
            font-size: 0.85em;
            color: var(--gray);
            font-weight: normal;
            margin-top: 5px;
        }

        /* Main Content */
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 20px;
        }

        section {
            background: white;
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 40px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        }

        h2 {
            color: var(--dark);
            font-size: 2em;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--primary);
        }

        h3 {
            color: var(--dark);
            font-size: 1.4em;
            margin: 40px 0 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h3::before {
            content: '';
            width: 4px;
            height: 24px;
            background: var(--primary);
            border-radius: 2px;
        }

        h4 {
            color: var(--secondary);
            font-size: 1.1em;
            margin: 25px 0 15px;
        }

        p {
            margin-bottom: 15px;
            color: #444;
        }

        /* Info Boxes */
        .box {
            padding: 25px;
            border-radius: 12px;
            margin: 25px 0;
        }

        .box-blue {
            background: linear-gradient(135deg, #e8f4fd, #d6eaf8);
            border-left: 5px solid var(--primary);
        }

        .box-green {
            background: linear-gradient(135deg, #e8f8f0, #d5f5e3);
            border-left: 5px solid var(--success);
        }

        .box-yellow {
            background: linear-gradient(135deg, #fef9e7, #fcf3cf);
            border-left: 5px solid var(--warning);
        }

        .box-red {
            background: linear-gradient(135deg, #fdedec, #f9d6d5);
            border-left: 5px solid var(--danger);
        }

        .box-purple {
            background: linear-gradient(135deg, #f5eef8, #e8daef);
            border-left: 5px solid var(--secondary);
        }

        .box h4 {
            margin: 0 0 10px 0;
            color: inherit;
        }

        .box p:last-child {
            margin-bottom: 0;
        }

        /* Diagrams */
        .diagram {
            background: #1a1a2e;
            color: #a0a0a0;
            padding: 30px;
            border-radius: 12px;
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 0.9em;
            line-height: 1.5;
            overflow-x: auto;
            margin: 25px 0;
            position: relative;
            white-space: pre;
        }

        .diagram::before {
            content: attr(data-title);
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 0.75em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .diagram .highlight {
            color: #4fc3f7;
        }

        .diagram .success {
            color: #81c784;
        }

        .diagram .warning {
            color: #ffb74d;
        }

        /* Code */
        .code {
            background: #1a1a2e;
            color: #e0e0e0;
            padding: 25px;
            border-radius: 12px;
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 0.9em;
            overflow-x: auto;
            margin: 20px 0;
            position: relative;
            white-space: pre;
        }

        .code::before {
            content: attr(data-lang);
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 0.7em;
            color: #666;
            text-transform: uppercase;
        }

        .code .comment { color: #6a9955; }
        .code .keyword { color: #569cd6; }
        .code .string { color: #ce9178; }
        .code .function { color: #dcdcaa; }
        .code .class { color: #4ec9b0; }
        .code .number { color: #b5cea8; }

        code {
            background: #f0f0f0;
            padding: 3px 8px;
            border-radius: 5px;
            font-family: 'SF Mono', 'Consolas', monospace;
            font-size: 0.9em;
            color: #e74c3c;
        }

        /* Cards Grid */
        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }

        .card {
            background: var(--light);
            border-radius: 12px;
            padding: 25px;
            position: relative;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            margin-bottom: 15px;
        }

        .card-blue .card-icon { background: var(--primary); color: white; }
        .card-green .card-icon { background: var(--success); color: white; }
        .card-yellow .card-icon { background: var(--warning); color: white; }
        .card-purple .card-icon { background: var(--secondary); color: white; }

        .card h4 {
            margin: 0 0 10px;
            color: var(--dark);
        }

        .card p {
            color: var(--gray);
            font-size: 0.95em;
            margin: 0;
        }

        /* Tables */
        .table-wrapper {
            overflow-x: auto;
            margin: 25px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95em;
        }

        th {
            background: var(--dark);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* Steps */
        .steps {
            display: flex;
            justify-content: space-between;
            margin: 40px 0;
            position: relative;
        }

        .steps::before {
            content: '';
            position: absolute;
            top: 30px;
            left: 60px;
            right: 60px;
            height: 4px;
            background: #ddd;
            z-index: 0;
        }

        .step {
            text-align: center;
            z-index: 1;
            flex: 1;
        }

        .step-num {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            font-weight: bold;
            margin: 0 auto 15px;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .step-title {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .step-desc {
            font-size: 0.85em;
            color: var(--gray);
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            margin: 2px;
        }

        .badge-blue { background: #e8f4fd; color: #2980b9; }
        .badge-green { background: #e8f8f0; color: #27ae60; }
        .badge-yellow { background: #fef9e7; color: #f39c12; }
        .badge-purple { background: #f5eef8; color: #8e44ad; }
        .badge-red { background: #fdedec; color: #e74c3c; }

        /* List */
        ul, ol {
            margin: 15px 0 15px 25px;
        }

        li {
            margin-bottom: 10px;
            color: #444;
        }

        /* Comparison */
        .comparison {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 30px 0;
        }

        .comparison-item {
            background: white;
            border: 2px solid #eee;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s;
        }

        .comparison-item:hover {
            border-color: var(--primary);
        }

        .comparison-item.recommended {
            border-color: var(--success);
            position: relative;
        }

        .comparison-item.recommended::before {
            content: 'DEFAULT';
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--success);
            color: white;
            padding: 4px 15px;
            border-radius: 20px;
            font-size: 0.7em;
            font-weight: bold;
        }

        .comparison-item h4 {
            margin: 15px 0 10px;
        }

        .comparison-item ul {
            text-align: left;
            font-size: 0.9em;
        }

        /* Footer */
        footer {
            background: var(--dark);
            color: white;
            text-align: center;
            padding: 40px 20px;
            margin-top: 60px;
        }

        footer a {
            color: var(--primary);
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .hero h1 { font-size: 2em; }
            section { padding: 25px; }
            .comparison { grid-template-columns: 1fr; }
            .steps { flex-direction: column; gap: 20px; }
            .steps::before { display: none; }
        }
    </style>
</head>
<body>

    <!-- Hero Section -->
    <header class="hero">
        <h1>V2N Robot <span>Technical Guide</span></h1>
        <p>Everything you need to understand, configure, and extend the Bowling Target Navigation System</p>
    </header>

    <!-- Table of Contents -->
    <nav class="toc">
        <h2>What's Inside This Guide</h2>
        <div class="toc-grid">
            <a href="#what-is-this">
                What Is This Robot?
                <span>Overview and capabilities</span>
            </a>
            <a href="#how-it-works">
                How It Works
                <span>System flow explained</span>
            </a>
            <a href="#hardware">
                Hardware Setup
                <span>Components and connections</span>
            </a>
            <a href="#detection">
                Detection System
                <span>YOLO, DRP, and switching</span>
            </a>
            <a href="#navigation">
                Navigation Logic
                <span>State machine explained</span>
            </a>
            <a href="#configuration">
                Configuration
                <span>Settings and customization</span>
            </a>
            <a href="#testing">
                Testing
                <span>Unit tests and mocks</span>
            </a>
            <a href="#troubleshooting">
                Troubleshooting
                <span>Common issues and fixes</span>
            </a>
        </div>
    </nav>

    <main class="container">

        <!-- Section 1: What Is This -->
        <section id="what-is-this">
            <h2>What Is This Robot?</h2>

            <p>The V2N Bowling Target Navigation Robot is an <strong>autonomous mobile robot</strong> that can:</p>

            <div class="cards">
                <div class="card card-blue">
                    <div class="card-icon">&#128270;</div>
                    <h4>Detect Bowling Pins</h4>
                    <p>Uses AI (YOLO) or V2N's DRP hardware to find bowling pins in camera images</p>
                </div>
                <div class="card card-green">
                    <div class="card-icon">&#128663;</div>
                    <h4>Navigate Autonomously</h4>
                    <p>Drives toward detected pins while avoiding obstacles using LiDAR</p>
                </div>
                <div class="card card-yellow">
                    <div class="card-icon">&#128506;</div>
                    <h4>Build Maps</h4>
                    <p>Creates 2D maps of the environment using SLAM (Simultaneous Localization and Mapping)</p>
                </div>
                <div class="card card-purple">
                    <div class="card-icon">&#127918;</div>
                    <h4>Easy Control</h4>
                    <p>Simple GUI with GO/STOP buttons, or control remotely from your PC</p>
                </div>
            </div>

            <h3>The Big Picture</h3>

            <div class="diagram" data-title="System Overview">
┌─────────────────────────────────────────────────────────────────────────────┐
│                           V2N ROBOT SYSTEM                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌──────────────┐      ┌──────────────┐      ┌──────────────┐             │
│   │   <span class="highlight">CAMERA</span>      │      │   <span class="highlight">LIDAR</span>      │      │   <span class="highlight">ARDUINO</span>    │             │
│   │  (USB)       │      │  (RPLidar)   │      │  (Motors)    │             │
│   └──────┬───────┘      └──────┬───────┘      └──────▲───────┘             │
│          │                     │                     │                      │
│          ▼                     ▼                     │                      │
│   ┌──────────────┐      ┌──────────────┐             │                      │
│   │  <span class="success">DETECTOR</span>    │      │  OBSTACLE    │             │                      │
│   │  YOLO/DRP    │      │  CHECKER     │             │                      │
│   └──────┬───────┘      └──────┬───────┘             │                      │
│          │                     │                     │                      │
│          └──────────┬──────────┘                     │                      │
│                     │                                │                      │
│                     ▼                                │                      │
│            ┌────────────────┐                        │                      │
│            │  <span class="warning">STATE MACHINE</span> │────────────────────────┘                      │
│            │  (Brain)       │                                               │
│            └────────────────┘                                               │
│                                                                              │
│   States: IDLE ──► SEARCHING ──► NAVIGATING ──► BLIND_APPROACH ──► ARRIVED  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
            </div>

            <div class="box box-blue">
                <h4>In Simple Terms</h4>
                <p>Think of it like this: The <strong>camera</strong> is the robot's eyes (finds pins), the <strong>LiDAR</strong> is like sonar (avoids walls), and the <strong>Arduino</strong> controls the wheels. The <strong>brain</strong> (state machine) decides what to do based on what the sensors see.</p>
            </div>
        </section>

        <!-- Section 2: How It Works -->
        <section id="how-it-works">
            <h2>How It Works - Step by Step</h2>

            <p>Here's exactly what happens when you press the <strong>GO</strong> button:</p>

            <div class="steps">
                <div class="step">
                    <div class="step-num">1</div>
                    <div class="step-title">Search</div>
                    <div class="step-desc">Rotate to find pins (SEARCHING)</div>
                </div>
                <div class="step">
                    <div class="step-num">2</div>
                    <div class="step-title">Calculate</div>
                    <div class="step-desc">Find direction & distance</div>
                </div>
                <div class="step">
                    <div class="step-num">3</div>
                    <div class="step-title">Navigate</div>
                    <div class="step-desc">Drive toward target (NAVIGATING)</div>
                </div>
                <div class="step">
                    <div class="step-num">4</div>
                    <div class="step-title">Approach</div>
                    <div class="step-desc">Blind approach if lost close (BLIND_APPROACH)</div>
                </div>
                <div class="step">
                    <div class="step-num">5</div>
                    <div class="step-title">Arrive</div>
                    <div class="step-desc">Target reached (ARRIVED)</div>
                </div>
            </div>

            <h3>Detection Process</h3>

            <div class="diagram" data-title="Detection Pipeline">
Camera Frame (640x480 BGR)
         │
         ▼
┌─────────────────────────────────────┐
│      PREPROCESSING                   │
│  • Resize to 640x640                 │
│  • Convert BGR → RGB                 │
│  • Normalize pixels (0-1)            │
└─────────────────┬───────────────────┘
                  │
                  ▼
┌─────────────────────────────────────┐
│      AI INFERENCE                    │
│  ┌─────────────┐ ┌─────────────┐    │
│  │ <span class="highlight">YOLO ONNX</span>  │ │ <span class="success">DRP BINARY</span> │    │  ← Choose one
│  │ (Software)  │ │ (Hardware)  │    │
│  └─────────────┘ └─────────────┘    │
└─────────────────┬───────────────────┘
                  │
                  ▼
┌─────────────────────────────────────┐
│      POSTPROCESSING                  │
│  • Filter by confidence (>35% configurable) │
│  • Apply NMS (remove duplicates)     │
│  • Calculate center position         │
└─────────────────┬───────────────────┘
                  │
                  ▼
        Detection Result:
        • Class: "bowling-pins"
        • Confidence: 0.95
        • Position: (320, 240)
        • Distance: ~1.5 meters
            </div>

            <h3>Distance Estimation</h3>

            <p>The robot estimates how far away the pin is based on <strong>how big it looks</strong> in the camera:</p>

            <div class="box box-green">
                <h4>The Formula</h4>
                <p><code>distance = reference_distance × (reference_box_height / current_box_height)</code></p>
                <ul>
                    <li><strong>reference_box_height</strong> = Known bounding box height at reference distance (default: 100px)</li>
                    <li><strong>reference_distance</strong> = Known distance where reference was measured (default: 1.0m)</li>
                    <li><strong>current_box_height</strong> = How tall the pin's bounding box is in the current image</li>
                </ul>
                <p style="margin-top:15px"><strong>Example:</strong> If reference is 100px at 1.0m, and the pin currently appears 50px tall → distance = 1.0 × (100 / 50) = 2.0 meters</p>
            </div>

            <h3>Movement Control</h3>

            <p>The robot uses <strong>mecanum wheels</strong> for omnidirectional movement:</p>

            <div class="diagram" data-title="Mecanum Wheel Layout">
         FRONT
    ┌─────────────┐
    │  ╲       ╱  │
    │   FL   FR   │     FL = Front Left
    │             │     FR = Front Right
    │   RL   RR   │     RL = Rear Left
    │  ╱       ╲  │     RR = Rear Right
    └─────────────┘
         REAR

Movement combinations:
• All forward  → Robot moves forward
• All backward → Robot moves backward
• FL+RR forward, FR+RL backward → Robot moves LEFT
• FR+RL forward, FL+RR backward → Robot moves RIGHT
• Left side forward, right side backward → Robot ROTATES
            </div>
        </section>

        <!-- Section 3: Hardware -->
        <section id="hardware">
            <h2>Hardware Setup</h2>

            <h3>What You Need</h3>

            <div class="table-wrapper">
                <table>
                    <tr>
                        <th>Component</th>
                        <th>Model</th>
                        <th>Connection</th>
                        <th>Purpose</th>
                    </tr>
                    <tr>
                        <td><strong>RZ/V2N Board</strong></td>
                        <td>Renesas RZ/V2N</td>
                        <td>Main computer</td>
                        <td>Runs ROS2, GUI, and AI</td>
                    </tr>
                    <tr>
                        <td><strong>Arduino</strong></td>
                        <td>Mega 2560</td>
                        <td><code>/dev/ttyACM0</code></td>
                        <td>Motor control & encoders</td>
                    </tr>
                    <tr>
                        <td><strong>LiDAR</strong></td>
                        <td>RPLidar A1</td>
                        <td><code>/dev/ttyUSB0</code></td>
                        <td>Obstacle detection & mapping</td>
                    </tr>
                    <tr>
                        <td><strong>Camera</strong></td>
                        <td>USB Camera</td>
                        <td><code>/dev/video0</code></td>
                        <td>Bowling pin detection</td>
                    </tr>
                    <tr>
                        <td><strong>Display</strong></td>
                        <td>HDMI Monitor</td>
                        <td>HDMI port</td>
                        <td>GUI display</td>
                    </tr>
                    <tr>
                        <td><strong>Motors</strong></td>
                        <td>4× DC Motors</td>
                        <td>Via Arduino</td>
                        <td>Mecanum wheel drive</td>
                    </tr>
                </table>
            </div>

            <h3>Wiring Diagram</h3>

            <div class="diagram" data-title="Connection Overview">
                        ┌─────────────────────────────────┐
                        │           RZ/V2N                │
                        │                                 │
    ┌──────────┐        │  USB1    USB2    USB3   HDMI   │
    │  LiDAR   │◄───────┼──○       ○       ○       ○     │
    │ RPLidar  │        │  │       │       │       │     │
    └──────────┘        │  │       │       │       │     │
                        └──┼───────┼───────┼───────┼─────┘
    ┌──────────┐           │       │       │       │
    │  Camera  │◄──────────┘       │       │       │
    │   USB    │                   │       │       │
    └──────────┘                   │       │       │
                                   │       │       │
    ┌──────────┐                   │       │       │
    │ Arduino  │◄──────────────────┘       │       │
    │  Mega    │                           │       │
    │    │     │                           │       └───► Monitor
    │    │     │                           │
    │    ▼     │                           │
    │ Motors   │                           │
    │ FL FR    │             ┌─────────────┘
    │ RL RR    │             │
    └──────────┘             ▼
                         Keyboard/Mouse (optional)
            </div>

            <div class="box box-yellow">
                <h4>Important: Port Assignment</h4>
                <p>The ports might be different on your system. Check with:</p>
                <p><code>ls -la /dev/ttyACM* /dev/ttyUSB* /dev/video*</code></p>
                <p>Update <code>config/robot_config.yaml</code> if your ports are different.</p>
            </div>
        </section>

        <!-- Section 4: Detection -->
        <section id="detection">
            <h2>Detection System</h2>

            <p>The robot supports <strong>multiple detection backends</strong>. You can switch between them without changing code!</p>

            <h3>Available Options</h3>

            <div class="comparison">
                <div class="comparison-item recommended">
                    <div style="font-size: 2.5em">&#129302;</div>
                    <h4>YOLO ONNX</h4>
                    <p><span class="badge badge-green">Default</span></p>
                    <ul>
                        <li>Works everywhere</li>
                        <li>Uses ONNX Runtime</li>
                        <li>CPU or GPU</li>
                        <li>~100ms inference</li>
                    </ul>
                </div>
                <div class="comparison-item">
                    <div style="font-size: 2.5em">&#9889;</div>
                    <h4>DRP Binary</h4>
                    <p><span class="badge badge-blue">V2N Hardware</span></p>
                    <ul>
                        <li>V2N accelerated</li>
                        <li>Uses DRP processor</li>
                        <li>External binary</li>
                        <li>~50ms inference</li>
                    </ul>
                </div>
                <div class="comparison-item">
                    <div style="font-size: 2.5em">&#128736;</div>
                    <h4>Mock Hardware</h4>
                    <p><span class="badge badge-yellow">Testing</span></p>
                    <ul>
                        <li>No hardware needed</li>
                        <li>MockCamera, MockArduino, MockLidar</li>
                        <li>Via factory: <code>create_camera(use_mock=True)</code></li>
                        <li>For unit testing</li>
                    </ul>
                </div>
            </div>

            <h3>How Detection Backend Is Selected</h3>

            <p>The camera thread (<code>camera_worker.py</code>) <strong>auto-detects</strong> the best available backend at startup:</p>

            <ol>
                <li><strong>DRP-AI</strong> — Tries first: looks for the DRP binary at <code>/opt/drp/yolo_detection</code> and model at <code>/opt/drp/drpai_model</code></li>
                <li><strong>YOLO ONNX</strong> — Falls back: searches for <code>.onnx</code> model files in <code>models/</code>, install, and build directories</li>
                <li><strong>No detector</strong> — If neither is available, camera runs without detection</li>
            </ol>

            <div class="box box-blue">
                <h4>Auto-Detection Priority</h4>
                <p>There is no environment variable or config switch for detector type. The code automatically tries DRP-AI first (available only on V2N hardware), then falls back to ONNX CPU. To force ONNX, simply ensure the DRP binary is not present.</p>
            </div>

            <h4>Configuration (config/robot_config.yaml)</h4>

            <div class="code" data-lang="yaml">
detection:
  confidence_threshold: <span class="number">0.35</span>
  target_class: <span class="string">"bowling-pins"</span>     <span class="comment"># Class name used by YOLO model</span>

  <span class="comment"># DRP-AI binary searched at:</span>
  <span class="comment"># /opt/drp/yolo_detection (default)</span>

  <span class="comment"># ONNX model searched in priority order:</span>
  <span class="comment"># bowling_yolov8m_int8.onnx, bowling_yolov8m.onnx, bowling_yolov5.onnx</span>
            </div>

            <h4>Method 3: In Code (For Developers)</h4>

            <div class="code" data-lang="python">
<span class="keyword">from</span> bowling_target_nav.detectors <span class="keyword">import</span> <span class="class">YoloOnnxDetector</span>, <span class="class">DrpBinaryDetector</span>

<span class="comment"># Create YOLO ONNX detector</span>
detector = <span class="class">YoloOnnxDetector</span>(model_path=<span class="string">"models/bowling_yolov8m.onnx"</span>)
detector.<span class="function">initialize</span>()

<span class="comment"># Or create DRP detector</span>
detector = <span class="class">DrpBinaryDetector</span>()
detector.<span class="function">initialize</span>()

<span class="comment"># Use it (same API for all detectors!)</span>
result = detector.<span class="function">detect</span>(camera_frame)
<span class="keyword">if</span> result.has_detections:
    pin = result.best_detection
    <span class="function">print</span>(f<span class="string">"Found pin at distance {pin.distance}m"</span>)
            </div>

            <h3>DRP Binary Protocol</h3>

            <p>If you're developing a custom DRP detector, here's the communication protocol:</p>

            <div class="diagram" data-title="stdin/stdout Pipe Protocol">
<span class="highlight">INPUT (Send to DRP binary via stdin pipe):</span>
┌────────────────────────────────────────────┐
│ HEADER (8 bytes)                           │
│ ├─ width      (4 bytes, uint32) = 640      │
│ └─ height     (4 bytes, uint32) = 480      │
├────────────────────────────────────────────┤
│ IMAGE DATA (width × height × 3)            │
│ = 640 × 480 × 3 = 921,600 bytes            │
│ Format: BGR pixels, row-major order        │
└────────────────────────────────────────────┘

<span class="success">OUTPUT (Read from DRP binary via stdout pipe):</span>
┌────────────────────────────────────────────┐
│ Single JSON line per frame, e.g.:          │
│                                            │
│ {                                          │
│   "detections": [                          │
│     {                                      │
│       "class_id": 0,                       │
│       "confidence": 0.87,                  │
│       "x1": 120, "y1": 80,                │
│       "x2": 200, "y2": 350                │
│     }                                      │
│   ],                                       │
│   "inference_ms": 45.2                     │
│ }                                          │
└────────────────────────────────────────────┘
            </div>
        </section>

        <!-- Section 5: Navigation -->
        <section id="navigation">
            <h2>Navigation Logic</h2>

            <p>The robot's behavior is controlled by a <strong>state machine</strong> - a simple way to organize different modes of operation.</p>

            <h3>State Machine Diagram</h3>

            <div class="diagram" data-title="Robot States">
                                    START
                                      │
                                      ▼
                              ┌───────────────┐
                              │     <span class="highlight">IDLE</span>      │  Robot is waiting
                              │  (gray #888)  │  Press GO to start
                              └───────┬───────┘
                                      │ GO pressed
                          ┌───────────┴───────────┐
                   no target visible         target visible
                          ▼                       ▼
                  ┌───────────────┐       ┌───────────────┐
   timeout 30s   │  <span class="warning">SEARCHING</span>   │       │  <span class="success">NAVIGATING</span>  │
  ┌──────────────│ (gold #e3b341)│       │(green #3fb950)│◄──────────┐
  │              └───────┬───────┘       └──┬─────┬──────┘           │
  │                      │ target found     │     │                  │
  │                      └─────────►────────┘     │                  │
  │                                               │                  │
  │  ┌────────────────────────────────────────────┘                  │
  │  │                                                               │
  │  │ target lost &gt;3s       target lost &gt;3s       within           │
  │  │ AND far (&gt;0.8m)       AND close (&lt;0.8m)    approach dist    │
  │  │                              │                    │           │
  │  │                              ▼                    │           │
  │  │                    ┌───────────────┐              │           │
  │  │   target           │ <span class="warning">BLIND_APPROACH</span>│              │           │
  │  │   re-detected      │(orange #ffa657│──────────────┤           │
  │  │   ┌────────────────│  dead-reckon) │              │           │
  │  │   │                └───┬───────┬───┘              │           │
  │  │   │                    │       │                  │           │
  │  │   │  heading &gt;45°     │       │ reached/LiDAR   │           │
  │  │   │  or timeout 8s    │       │ stop             │           │
  │  │   │                    │       │                  │           │
  │  └───┼──►─SEARCHING◄─────┘       ▼                  ▼           │
  │      │                    ┌───────────────┐                     │
  │      └────────────────────│   <span class="highlight">ARRIVED</span>     │                     │
  └──────────►IDLE            │(blue #58a6ff) │  Target reached     │
                              │  (terminal)   │                     │
                              └───────┬───────┘                     │
                                      │ GO pressed again            │
                                      └─────────────────────────────┘

        <span class="highlight">STOP button</span> → Can be pressed from ANY state → returns to IDLE
            </div>

            <h3>State Details</h3>

            <div class="table-wrapper">
                <table>
                    <tr>
                        <th>State</th>
                        <th>What Happens</th>
                        <th>Movement</th>
                        <th>Transitions To</th>
                    </tr>
                    <tr>
                        <td><span class="badge" style="background:#eee;color:#888">IDLE</span></td>
                        <td>Robot waits for GO command</td>
                        <td>Stopped</td>
                        <td>SEARCHING (on GO, no target visible)<br>NAVIGATING (on GO, target visible)</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-yellow">SEARCHING</span></td>
                        <td>Rotating in place to find bowling pins</td>
                        <td>Spinning in place</td>
                        <td>NAVIGATING (target found)<br>IDLE (timeout 30s)</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-green">NAVIGATING</span></td>
                        <td>Drives toward detected pin using holonomic drive</td>
                        <td>Forward + turning</td>
                        <td>SEARCHING (target lost &gt;3s AND far &gt;0.8m)<br>BLIND_APPROACH (target lost &gt;3s AND close &lt;0.8m)<br>ARRIVED (within approach distance)</td>
                    </tr>
                    <tr>
                        <td><span class="badge" style="background:#fff3e0;color:#e65100">BLIND_APPROACH</span></td>
                        <td>Dead-reckoning toward last known pin position when camera loses sight of it</td>
                        <td>Forward toward last known position</td>
                        <td>ARRIVED (reached or LiDAR stop)<br>SEARCHING (heading diverge &gt;45° or timeout 8s)<br>NAVIGATING (target re-detected)</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-blue">ARRIVED</span></td>
                        <td>Reached the target. Terminal state.</td>
                        <td>Stopped</td>
                        <td>IDLE (STOP pressed)<br>Restarts on GO pressed</td>
                    </tr>
                </table>
            </div>

            <h3>Navigation Parameters</h3>

            <p>These settings control how the robot moves:</p>

            <div class="code" data-lang="yaml">
navigation:
  <span class="comment"># Speed limits</span>
  max_linear_speed: <span class="number">0.3</span>      <span class="comment"># Maximum forward speed (m/s)</span>
  max_angular_speed: <span class="number">0.5</span>     <span class="comment"># Maximum rotation speed (rad/s)</span>

  <span class="comment"># Default speeds</span>
  default_linear_speed: <span class="number">0.15</span>  <span class="comment"># Normal driving speed</span>
  default_angular_speed: <span class="number">0.3</span> <span class="comment"># Normal turning speed</span>

  <span class="comment"># Obstacle avoidance</span>
  obstacle_distance_threshold: <span class="number">0.25</span>  <span class="comment"># Stop if obstacle closer than this (meters)</span>
  obstacle_slowdown_distance: <span class="number">0.5</span>   <span class="comment"># Start slowing down at this distance</span>

  <span class="comment"># Target approach</span>
  target_reached_distance: <span class="number">0.15</span>     <span class="comment"># "I'm there" when this close (meters)</span>

  <span class="comment"># Search behavior (when target is lost)</span>
  search:
    enabled: <span class="keyword">true</span>
    lost_timeout: <span class="number">3.0</span>        <span class="comment"># Start searching after losing target for this many seconds</span>
    search_timeout: <span class="number">30.0</span>     <span class="comment"># Give up searching after this long</span>
    angular_speed: <span class="number">0.4</span>       <span class="comment"># How fast to spin while searching (rad/s)</span>

  <span class="comment"># Blind approach (when target lost but close)</span>
  blind_approach:
    enabled: <span class="keyword">true</span>
    distance_threshold: <span class="number">0.8</span>  <span class="comment"># Switch to blind approach if last known distance &lt; this</span>
    timeout: <span class="number">8.0</span>             <span class="comment"># Give up blind approach after this many seconds</span>
    heading_tolerance: <span class="number">45.0</span>  <span class="comment"># Abort if heading diverges more than this (degrees)</span>
            </div>
        </section>

        <!-- Section 6: Configuration -->
        <section id="configuration">
            <h2>Configuration</h2>

            <p>All settings are in one file: <code>config/robot_config.yaml</code></p>

            <h3>Configuration Sections</h3>

            <div class="cards">
                <div class="card card-blue">
                    <h4>detection:</h4>
                    <p>AI model, confidence threshold, target class</p>
                </div>
                <div class="card card-green">
                    <h4>navigation:</h4>
                    <p>Speeds, obstacles, search behavior</p>
                </div>
                <div class="card card-yellow">
                    <h4>camera:</h4>
                    <p>Resolution, FPS, device ID</p>
                </div>
                <div class="card card-purple">
                    <h4>arduino/lidar:</h4>
                    <p>Port paths, baud rates</p>
                </div>
            </div>

            <h3>Display Environment Variables</h3>

            <p>These are set automatically by <code>gui/display.py</code> at startup:</p>

            <div class="table-wrapper">
                <table>
                    <tr>
                        <th>Variable</th>
                        <th>What It Does</th>
                        <th>Default</th>
                    </tr>
                    <tr>
                        <td><code>GDK_BACKEND</code></td>
                        <td>GTK display backend</td>
                        <td><code>wayland</code></td>
                    </tr>
                    <tr>
                        <td><code>WAYLAND_DISPLAY</code></td>
                        <td>Wayland socket name</td>
                        <td><code>wayland-0</code></td>
                    </tr>
                    <tr>
                        <td><code>XDG_RUNTIME_DIR</code></td>
                        <td>Runtime directory</td>
                        <td><code>/run</code></td>
                    </tr>
                    <tr>
                        <td><code>OPENCV_OPENCL_DEVICE</code></td>
                        <td>Prevent DRP-AI conflicts</td>
                        <td><code>disabled</code></td>
                    </tr>
                </table>
            </div>

            <div class="box box-yellow">
                <h4>Note on Configuration</h4>
                <p>Navigation parameters, detection thresholds, and obstacle settings are configured through the <strong>Settings GUI</strong> (5 tabs) at runtime. Hardware ports are set in <code>config/robot_config.yaml</code>. The detector backend is auto-detected (DRP-AI first, then ONNX fallback).</p>
            </div>
        </section>

        <!-- Section 7: Testing -->
        <section id="testing">
            <h2>Testing</h2>

            <p>The project includes <strong>mock components</strong> so you can test without hardware!</p>

            <h3>Test Without Hardware</h3>

            <div class="code" data-lang="bash">
<span class="comment"># Run all unit tests (no hardware needed!)</span>
pytest test/unit/ -v

<span class="comment"># Example output:</span>
test_config.py::TestConfig::test_default_config <span class="success">PASSED</span>
test_state_machine.py::TestRobotStateMachine::test_initial_state <span class="success">PASSED</span>
test_detectors.py::TestMockDetector::test_always_detect_mode <span class="success">PASSED</span>
test_hardware.py::TestMockArduino::test_connect <span class="success">PASSED</span>
<span class="success">==================== 42 passed in 2.3s ====================</span>
            </div>

            <h3>Using Mock Components in Your Code</h3>

            <div class="code" data-lang="python">
<span class="keyword">from</span> bowling_target_nav.hardware <span class="keyword">import</span> create_arduino, create_camera, create_lidar
<span class="keyword">from</span> bowling_target_nav.detectors <span class="keyword">import</span> <span class="class">YoloOnnxDetector</span>, <span class="class">DrpBinaryDetector</span>

<span class="comment"># Create MOCK components (no hardware needed!)</span>
arduino = <span class="function">create_arduino</span>(use_mock=<span class="keyword">True</span>)
camera = <span class="function">create_camera</span>(use_mock=<span class="keyword">True</span>, pattern=<span class="string">"gradient"</span>)
lidar = <span class="function">create_lidar</span>(use_mock=<span class="keyword">True</span>)

<span class="comment"># Add fake obstacles to test avoidance</span>
lidar.<span class="function">add_obstacle</span>(angle=<span class="number">0</span>, distance=<span class="number">0.5</span>, width=<span class="number">30</span>)

<span class="comment"># Test your code!</span>
frame = camera.<span class="function">get_frame</span>()
scan = lidar.<span class="function">get_scan</span>()
arduino.<span class="function">set_velocity</span>(<span class="number">0.1</span>, <span class="number">0.0</span>)

<span class="comment"># Check what commands were sent</span>
<span class="function">print</span>(arduino.<span class="function">get_command_history</span>())
            </div>

            <h3>Test Types</h3>

            <div class="cards">
                <div class="card card-green">
                    <h4>Unit Tests (test/unit/)</h4>
                    <p>No hardware needed. Tests individual components using mocks.</p>
                    <p><code>pytest test/unit/ -v</code></p>
                </div>
                <div class="card card-yellow">
                    <h4>Hardware Tests (test/hardware/)</h4>
                    <p>Requires actual hardware connected. Tests real communication.</p>
                    <p><code>./run_tests.sh arduino</code></p>
                </div>
            </div>
        </section>

        <!-- Section 8: Troubleshooting -->
        <section id="troubleshooting">
            <h2>Troubleshooting</h2>

            <h3>Common Issues</h3>

            <div class="box box-red">
                <h4>Robot Not Moving</h4>
                <p><strong>Symptoms:</strong> Press GO but nothing happens</p>
                <p><strong>Check:</strong></p>
                <ul>
                    <li>Is Arduino connected? <code>ls /dev/ttyACM0</code></li>
                    <li>Is a target detected? Check camera feed for green box</li>
                    <li>Check logs: <code>journalctl -u robot -f</code></li>
                </ul>
                <p><strong>Fix:</strong> <code>./v2n_master_setup.sh --stop && ./v2n_master_setup.sh --start</code></p>
            </div>

            <div class="box box-yellow">
                <h4>No Detection (Camera Working)</h4>
                <p><strong>Symptoms:</strong> Camera shows image but no detection boxes</p>
                <p><strong>Check:</strong></p>
                <ul>
                    <li>Is the bowling pin in frame?</li>
                    <li>Is confidence threshold too high? Try 0.3</li>
                    <li>Is the YOLO model file present?</li>
                </ul>
                <p><strong>Fix:</strong> Check <code>config/robot_config.yaml</code> confidence_threshold</p>
            </div>

            <div class="box box-blue">
                <h4>GUI Not Starting</h4>
                <p><strong>Symptoms:</strong> Command runs but no window appears</p>
                <p><strong>Check:</strong></p>
                <ul>
                    <li>Is display connected? <code>echo $DISPLAY</code></li>
                    <li>Is Wayland/X11 running?</li>
                </ul>
                <p><strong>Fix:</strong> <code>export DISPLAY=:0</code> then restart</p>
            </div>

            <h3>Debug Commands</h3>

            <div class="code" data-lang="bash">
<span class="comment"># Check all hardware</span>
./run_tests.sh --check

<span class="comment"># View live logs</span>
journalctl -u robot -f

<span class="comment"># Check service status</span>
systemctl status robot

<span class="comment"># Test individual components</span>
./run_tests.sh arduino
./run_tests.sh lidar
./run_tests.sh camera

<span class="comment"># Run in debug mode</span>
<span class="keyword">export</span> V2N_LOG_LEVEL=DEBUG
./v2n_master_setup.sh --start
            </div>
        </section>

    </main>

    <footer>
        <p><strong>V2N Bowling Target Navigation</strong> - Technical Guide</p>
        <p style="margin-top: 15px">
            <a href="quick_start_guide.html">&#8592; Quick Start Guide</a>
        </p>
    </footer>

</body>
</html>
